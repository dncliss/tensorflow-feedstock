From bff4d2d3edfd1b95425f599d8f883df78194a296 Mon Sep 17 00:00:00 2001
From: Jason Furmanek <furmanek@us.ibm.com>
Date: Thu, 23 Apr 2020 17:10:49 +0000
Subject: [PATCH] icu cve

---
 third_party/icu/CVE-2020-10531-udata.patch | 77 ++++++++++++++++++++++
 third_party/icu/workspace.bzl              |  2 +-
 2 files changed, 78 insertions(+), 1 deletion(-)
 create mode 100644 third_party/icu/CVE-2020-10531-udata.patch

diff --git a/third_party/icu/CVE-2020-10531-udata.patch b/third_party/icu/CVE-2020-10531-udata.patch
new file mode 100644
index 0000000000..f89da9fbdd
--- /dev/null
+++ b/third_party/icu/CVE-2020-10531-udata.patch
@@ -0,0 +1,77 @@
+diff -Naupr icu-release-64-2-orig/icu4c/source/common/udata.cpp icu-release-64-2-squash/icu4c/source/common/udata.cpp
+--- icu-release-64-2-orig/icu4c/source/common/udata.cpp	2020-04-17 21:19:12.956433860 +0000
++++ icu-release-64-2-squash/icu4c/source/common/udata.cpp	2020-04-20 21:00:52.342996737 +0000
+@@ -18,11 +18,10 @@
+ 
+ #include "unicode/utypes.h"  /* U_PLATFORM etc. */
+ 
+-#ifdef __GNUC__
+-/* if gcc
+-#define ATTRIBUTE_WEAK __attribute__ ((weak))
+-might have to #include some other header
+-*/
++#if defined(__GNUC__) || defined(__SUNPRO_CC)
++#  define ATTRIBUTE_WEAK __attribute__ ((weak))
++#else
++#  define ATTRIBUTE_WEAK
+ #endif
+ 
+ #include "unicode/putil.h"
+@@ -649,10 +648,9 @@ extern "C" const DataHeader U_DATA_API U
+  * partial-data-library access functions where each returns a pointer
+  * to its data package, if it is linked in.
+  */
+-/*
+-extern const void *uprv_getICUData_collation(void) ATTRIBUTE_WEAK;
+-extern const void *uprv_getICUData_conversion(void) ATTRIBUTE_WEAK;
+-*/
++U_CDECL_BEGIN
++const void *uprv_getICUData_conversion(void) ATTRIBUTE_WEAK;
++U_CDECL_END
+ 
+ /*----------------------------------------------------------------------*
+  *                                                                      *
+@@ -710,10 +708,11 @@ openCommonData(const char *path,
+         if (uprv_getICUData_collation) {
+             setCommonICUDataPointer(uprv_getICUData_collation(), FALSE, pErrorCode);
+         }
++        */
+         if (uprv_getICUData_conversion) {
+             setCommonICUDataPointer(uprv_getICUData_conversion(), FALSE, pErrorCode);
+         }
+-        */
++
+ #if U_PLATFORM_HAS_WINUWP_API == 0 // Windows UWP Platform does not support dll icu data at this time
+         setCommonICUDataPointer(&U_ICUDATA_ENTRY_POINT, FALSE, pErrorCode);
+         {
+diff -Naupr icu-release-64-2-orig/icu4c/source/common/unicode/uconfig.h icu-release-64-2-squash/icu4c/source/common/unicode/uconfig.h
+--- icu-release-64-2-orig/icu4c/source/common/unicode/uconfig.h	2020-04-17 21:19:12.966433475 +0000
++++ icu-release-64-2-squash/icu4c/source/common/unicode/uconfig.h	2020-04-20 21:00:52.342996737 +0000
+@@ -55,6 +55,11 @@
+ #include "uconfig_local.h"
+ #endif
+ 
++// Tensorflow is statically linked on all platforms.
++#ifndef U_STATIC_IMPLEMENTATION
++#define U_STATIC_IMPLEMENTATION
++#endif
++
+ /**
+  * \def U_DEBUG
+  * Determines whether to include debugging code.
+diff -Naupr icu-release-64-2-orig/icu4c/source/common/unistr.cpp icu-release-64-2-squash/icu4c/source/common/unistr.cpp
+--- icu-release-64-2-orig/icu4c/source/common/unistr.cpp	2020-04-17 21:19:12.976433090 +0000
++++ icu-release-64-2-squash/icu4c/source/common/unistr.cpp	2020-04-20 21:01:02.532602823 +0000
+@@ -1563,7 +1563,11 @@ UnicodeString::doAppend(const UChar *src
+   }
+ 
+   int32_t oldLength = length();
+-  int32_t newLength = oldLength + srcLength;
++  int32_t newLength;
++  if (uprv_add32_overflow(oldLength, srcLength, &newLength)) {
++    setToBogus();
++    return *this;
++  }
+ 
+   // Check for append onto ourself
+   const UChar* oldArray = getArrayStart();
diff --git a/third_party/icu/workspace.bzl b/third_party/icu/workspace.bzl
index a2131a5005..a919fb1c69 100644
--- a/third_party/icu/workspace.bzl
+++ b/third_party/icu/workspace.bzl
@@ -18,5 +18,5 @@ def repo():
         ],
         build_file = "//third_party/icu:BUILD.bazel",
         system_build_file = "//third_party/icu:BUILD.system",
-        patch_file = clean_dep("//third_party/icu:udata.patch"),
+        patch_file = clean_dep("//third_party/icu:CVE-2020-10531-udata.patch"),
     )
-- 
2.23.0

